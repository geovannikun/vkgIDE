<!doctype html>
<html>
    <head>
        <title>vkgIDE</title>
        <script src="lib/codemirror.js"></script>
        <script src="mode/meta.js"></script>
        <script src="addon/selection/active-line.js"></script>
        <script src="addon/edit/matchbrackets.js"></script>
        <script src="addon/edit/trailingspace.js"></script>
        <script src="addon/hint/show-hint.js"></script>
        <script src="addon/hint/javascript-hint.js"></script>
        <script src="addon/fold/foldcode.js"></script>
        <script src="addon/fold/foldgutter.js"></script>
        <script src="addon/fold/brace-fold.js"></script>
        <script src="addon/fold/xml-fold.js"></script>
        <script src="addon/fold/comment-fold.js"></script>
        <script src="addon/tern/tern.js"></script>
        <script src="addon/format/autoFormatAll.js"></script>
        <script src="addon/format/formatting.js"></script>
        <script src="addon/project/project.js"></script>
        <script>
            var editor;
            var projects = [];
            var fileOpened;
            function include(url,callback){
                var head = document.getElementsByTagName('head')[0];
                var script = document.createElement('script');
                script.type = 'text/javascript';
                script.src = url;
                script.onreadystatechange = callback;
                script.onload = callback;
                head.appendChild(script);
            }
            function betterTab(cm) {
                if (cm.somethingSelected()) {
                    cm.indentSelection("add");
                } else {
                    cm.replaceSelection(cm.getOption("indentWithTabs")? "\t":
                    Array(cm.getOption("indentUnit") + 1).join(" "), "end", "+input");
                }
            }
            function disablePopups(){
                ul = document.querySelectorAll(".cc-cf > ul");
                for(var i = 0;i<ul.length;i++){
                    ul[i].className = "disable";
                }
            }
            function updatePreview() {
                console.log("teste");
                var previewFrame = document.getElementById('preview');
                var preview =  previewFrame.contentDocument ||  previewFrame.contentWindow.document;
                preview.open();
                preview.write(editor.getValue());
                preview.close();
            }
            function showLanguages(){
                document.getElementById("cc-languages").className = document.getElementById("cc-languages").className=="disable"?"enable":"disable";
            }
            function showIndent(){
                document.getElementById("cc-indent").className = document.getElementById("cc-indent").className=="disable"?"enable":"disable";
            }
            function newProject(){
                window.frame.openDialog({
                    type : 'open',
                    title : 'Select the Project Folder',
                    multiSelect: false,
                    dirSelect : true
                }, function (err, folders) {
                    if(!err || folders.length!=0){
                        folder = folders[0];
                        console.log(folder);
                        project = new Project(folder);
                        project.name = folder;
                        document.getElementById("archives").innerHTML = "";
                        project.folders.forEach(function(f){
                            console.log(f);
                            document.getElementById("archives").appendChild(f.getHTML());
                        });
                        project.files.forEach(function(f){
                            console.log(f);
                            document.getElementById("archives").appendChild(f.getHTML());
                        });
                    }
                });
            }
            function setIndent(){
                numberField = document.querySelector("#cc-indent > li > input[type='text']");
                if(!/^[0-9]+$/.test(numberField.value)){
                    numberField.value = "";
                }
                var number = numberField.value==""?0:numberField.value;
                var isTab = document.querySelector("#cc-indent > li > input:checked").value=="tab";
                editor.setOption("tabSize", number);
                editor.setOption("indentUnit", number);
                editor.setOption("indentWithTabs", isTab);
                document.querySelector(".cc-indent > p").innerHTML = number+" "+(isTab?"Tabs":"Spaces");
                editor.refresh();
            }
            function setLanguage(l){
                disablePopups();
                var name;
                for(i in CodeMirror.modeInfo){
                    if(CodeMirror.modeInfo[i].mime == l){
                        name = CodeMirror.modeInfo[i].name;
                    }
                }
                document.getElementsByClassName("cc-language")[0].getElementsByTagName("p")[0].innerHTML = name;
                editor.setOption("mode", l);
                editor.refresh();
            }
            function setWrap(){
                editor.setOption("lineWrapping", !editor.getOption("lineWrapping"));
                document.querySelector(".cc-wrap > p").innerHTML = editor.getOption("lineWrapping")?"Wrap":"No Wrap";
            }
            function selectFile(cm){
                window.frame.openDialog({
                    type : 'open',
                    title : 'Open file',
                    multiSelect: false,
                    dirSelect : false
                }, function (err, files) {
                    if (!err) {
                        console.log(fs);
                        var f = new File(files[0]);
                        document.title = f.name + " - vkgIDE"
                        cm.setValue(f.load());
                        editor.setOption("mode", f.mimetype);
                        editor.refresh();
                        fileOpened = f;
                    } else {
                        console.log(err);
                    }
                });
            }
            function openFile(dir){
            }
            function saveFile(cm){
                fileOpened.save(cm.getValue());
                console.log("saved");
            }
            function upFontSize(){
                size = document.querySelector(".CodeMirror").style.fontSize;
                console.log(parseInt((size==""?"11pt":size).replace("pt","")) - 1);
                document.querySelector(".CodeMirror").style.fontSize = (parseInt((size==""?"11pt":size).replace("pt","")) + 1) + "pt";
                document.querySelector(".cc-fontSize > p").innerHTML = "Font: " + document.querySelector(".CodeMirror").style.fontSize;
            }
            function downFontSize(){
                size = document.querySelector(".CodeMirror").style.fontSize;
                console.log(parseInt((size==""?"11pt":size).replace("pt","")) - 1);
                document.querySelector(".CodeMirror").style.fontSize = (parseInt((size==""?"11pt":size).replace("pt","")) - 1) + "pt";
                document.querySelector(".cc-fontSize > p").innerHTML = "Font: " + document.querySelector(".CodeMirror").style.fontSize;
            }
            function start(){
                editor = CodeMirror(document.body,
                {
                    value: "function myScript(){\nreturn 100;\n}",
                    mode:  "none",
                    lineNumbers: true,
                    extraKeys: {
                        "Ctrl-Space": "autocomplete",
                        "Ctrl-Q": function(cm){ cm.foldCode(cm.getCursor()); },
                        "Ctrl-J": function(cm){ 
                            cm.autoFormatAll({
                                line: 0,
                                ch: 0
                            }, {
                                line: cm.lineCount(),
                                ch: 0
                            }); 
                        },
                        "Ctrl-O": selectFile,
                        "Ctrl-S": saveFile,
                        Tab: betterTab
                    },
                    styleActiveLine: true,
                    matchBrackets: true,
                    theme:"ambiance",
                    foldGutter: true,
                    lineWrapping: true,
                    indentWithTabs: false,
                    indentUnit: 4,
                    tabSize: 4,
                    lineWrapping:false,
                    showTrailingSpace: true,
                    gutters: ["CodeMirror-linenumbers", "CodeMirror-foldgutter"]
                });
                editor.focus();
                editor.on("focus",disablePopups);
                /*editor.on("change",updatePreview);*/
                CodeMirror.commands.autocomplete = function(cm) {
                    CodeMirror.showHint(cm, CodeMirror.hint.javascript);
                };
                for(var i=0;i<CodeMirror.modeInfo.length;i++){
                    document.getElementById("cc-languages").innerHTML+="<li onclick='setLanguage(\""+CodeMirror.modeInfo[i].mime+"\")'>"+CodeMirror.modeInfo[i].name+"</li>";
                    if(CodeMirror.modeInfo[i].mode!="null"){
                        include("mode/"+CodeMirror.modeInfo[i].mode+"/"+CodeMirror.modeInfo[i].mode+".js",function(){});
                    }
                }
            }
        </script>
        <link rel="stylesheet" href="css/reset.css" />
        <link rel="stylesheet" href="css/geovanni.css" />
        <link rel="stylesheet" href="css/tree.css">
        <link rel="stylesheet" href="lib/codemirror.css">
        <link rel="stylesheet" href="addon/hint/show-hint.css">
        <link rel="stylesheet" href="theme/ambiance_g.css">
        <link rel="stylesheet" href="css/global.css">
    </head>
    <body onload="start()">
        <div id='open-folder' style="display:none">
            <p>/home/geovanni/</p>
            <ul>
                <li>Folder 1</li>
                <li>Folder 2</li>
            </ul>
        </div>
        <div id='code-config'>
            <span class='cc-language cc-cf'>
                <p onclick="showLanguages()">Plain Text</p>
                <ul id='cc-languages' class="disable">
                </ul>
            </span>
            <span class='cc-indent cc-cf'>
                <p onclick="showIndent()">4 Spaces</p>
                <ul id='cc-indent' class="disable">
                    <li onclick="setIndent()">Size <input onkeyup="setIndent()" type="text" value="4"></li>
                    <li onclick="setIndent()"><input id='tab' type="radio" name="indent" value="tab"><label for="tab">Tab</label><input id='space' type="radio" name="indent" value="space" checked><label for="space">Space</label></li>
                </ul>   
            </span>
            <span class='cc-fontSize cc-cf'>
                <button onclick="downFontSize()">-</button>
                <p>Font: 11pt</p>
                <button onclick="upFontSize()">+</button>
            </span>
            <span class='cc-wrap cc-cf'>
                <p onclick="setWrap()">No Wrap</p>
            </span>
        </div>
        <div id='archive-menu'>
            <span class='selectProject'>
                <p>Projeto Selecionado</p>
                <ul class='projects'>
                    <li class="newProject" onclick="newProject()">New Project...</li>
                    <li>Projeto 1</li>
                    <li>Projeto 2</li>
                </ul>
            </span>
            <ul id='archives' class='tree-js'>
            </ul>
        </div>
        <!--<iframe id="preview"></iframe>-->
    </body>
</html>
